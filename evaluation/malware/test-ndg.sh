#!/bin/sh

INSTALL_TIME_CBOM=1

test() {
	testcase="$1"
	container_name="$(echo "$testcase" | sed 's/@//g')"

  package="${testcase%-*}"
  version="${testcase##*-}"

	printf 'testing %s...' "$testcase"

	docker run -dit \
		--rm \
		--workdir "/home/malware" \
		--mount "type=bind,source=$(pwd),target=/home/malware" \
		--env 'DANGEROUS_RUN_MALWARE=1' \
		--name "npm-dependency-guardian-$container_name" \
		'npm-dependency-guardian-malware-evaluation' \
		1>/dev/null 2>/dev/null

	# Set up the testcase
	docker exec --workdir "/home/malware/$testcase" "npm-dependency-guardian-$container_name" \
		'bash' '-c' "source /root/.nvm/nvm.sh && ../.setup.sh $package $version" \
		1>/dev/null 2>/dev/null
	if [ -n "$INSTALL_TIME_CBOM" ] && [ -f "./$testcase/ndg-install.json" ]; then
		# for packages with malicious install scripts, optionally use a generated
		# node policy based on the previous benign version's install scripts only,
		# stored as `ndg.json`.
		docker exec "npm-dependency-guardian-$container_name" \
			'cp' "/home/malware/$testcase/ndg.json" '/tmp/node_policy.json' \
			1>/dev/null 2>/dev/null
	elif [ -f "./$testcase/ndg.json" ]; then
		# for malicious package *updates* the node policy was generated based on the
		# previous benign version and stored as `ndg.json`.
		docker exec "npm-dependency-guardian-$container_name" \
			'cp' "/home/malware/$testcase/ndg.json" '/tmp/node_policy.json' \
			1>/dev/null 2>/dev/null
	else
		docker exec "npm-dependency-guardian-$container_name" \
			'/root/.nvm/versions/node/v18.20.8/bin/node' \
			'/home/poc/npm-dependency-guardian/npm-dependency-guardian/src/main.js' \
			"/home/malware/$testcase" \
			'--overwrite' '--no-backup' \
			'--custom-modules' \
			1>/dev/null 2>/dev/null
	fi

	# Run the test case
	out=$( \
		docker exec --workdir "/home/malware/$testcase" "npm-dependency-guardian-$container_name" \
			'/home/poc/npm-dependency-guardian/nodejs-patch/node/out/Release/node' \
			'./index.js' \
			2>/dev/null
	)
	result=$?

	# Clean up
	docker exec --workdir "/home/malware/$testcase" "npm-dependency-guardian-$container_name" \
		'rm' '-rf' './node_modules' \
		1>/dev/null 2>/dev/null
	docker stop "npm-dependency-guardian-$container_name" 1>/dev/null 2>/dev/null &

	printf '\r                                                        '
	if [ $result -eq 0 ]; then
		echo "$out" >ndg.log
		violations=$(node parse-ndg-logs.mjs "$package")
		rm ndg.log
		violation_count=$(echo "$violations" | grep -cve '^$')
		if [ "$violation_count" -eq 0 ]; then
			printf 'NOT PREVENTED'
		else
			printf 'PREVENTED'
		fi
	else
		printf "UNEXPECTED (got '%s')" "$result"
	fi
	printf '\r%s \n' "$testcase"
}

if [ -n "$NODE_SHIELD_CONTAINER" ]; then
	echo '== TESTING (Npm Dependency Guardian) =='
	echo 'cannot run this evaluation inside the NodeShield container.'
	echo 'please run it from the NodeShield repository instead.'
	exit 0
else
	printf 'Building Npm Dependency Guardian image for testing...'
	docker run -dit --rm \
		--name 'npm-dependency-guardian-build' \
		'ghcr.io/kth-langsec/npm-dependency-guardian' \
		1>/dev/null 2>/dev/null

	printf '\r                                                                   '
	printf '\rInstalling Node.js in container 1/4'
	docker exec npm-dependency-guardian-build \
		'apt' 'install' '-y' 'curl' \
		1>/dev/null 2>/dev/null
	printf '\rInstalling Node.js in container 2/4'
	docker exec npm-dependency-guardian-build \
		'curl' '-o' '/tmp/install-node.sh' 'https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh' \
		1>/dev/null 2>/dev/null
	printf '\rInstalling Node.js in container 3/4'
	docker exec npm-dependency-guardian-build \
		'bash' '/tmp/install-node.sh' \
		1>/dev/null 2>/dev/null
	printf '\rInstalling Node.js in container 4/4'
	docker exec npm-dependency-guardian-build \
		'bash' '-c' 'source /root/.nvm/nvm.sh && nvm install 18.20.8' \
		1>/dev/null 2>/dev/null

	printf '\r                                                                   '
	printf '\rInitializing the Npm Dependency Guardian tool...'
	docker exec --workdir '/home/poc/npm-dependency-guardian/npm-dependency-guardian' npm-dependency-guardian-build \
		'bash' '-c' 'source /root/.nvm/nvm.sh && npm clean-install' \
		1>/dev/null 2>/dev/null

	printf '\r                                                                   '
	printf '\rStoring the prepared Npm Dependency Guardian image...'
	docker commit npm-dependency-guardian-build npm-dependency-guardian-malware-evaluation 1>/dev/null 2>/dev/null
	docker stop npm-dependency-guardian-build  1>/dev/null 2>/dev/null &

	printf '\r                                                                 \r'
	echo '== TESTING (Npm Dependency Guardian) =='
	cases=$(ls -d ./*/)
	for dir in $cases; do
		dir=${dir#./}
		dir=${dir%/}

		test "$dir"
	done

	docker rmi --force npm-dependency-guardian-malware-evaluation
fi
