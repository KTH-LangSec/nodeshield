#!/bin/sh

package="$1"
version="$2"

ignorescripts="--ignore-scripts=true"
if [ "$package" = "electron-native-notify" ]; then ignorescripts="--ignore-scripts=false"; fi

npm clean-install \
	--no-audit \
	--no-fund \
	--no-update-notifier \
	"$ignorescripts"

rm -rf "./node_modules/$package"
package_name_tarball=$(echo "$package" | sed 's/\//-/g')
tar -xzf "../.tarballs/$package_name_tarball-$version.tgz" -C './node_modules'

# this next line handles archives that unpack to a "package" folder, some
# archives unpack directly to the correct name, for the former we'll move it.
# If neither of these two options is the case, we'll get an error later in the
# pipeline...
if [ -d './node_modules/package' ]; then
	mv './node_modules/package' "./node_modules/$package"
fi

if [ -f './setup.sh' ]; then
	./setup.sh
fi

if [ -n "$INSTALL_TIME_CBOM" ]; then
	if [ "$package" = 'eslint-scope' ]; then
		mv node_modules/eslint-scope/lib/build.js .
		rm node_modules/eslint-scope/lib/*.js
		mv ./build.js node_modules/eslint-scope/lib/
	elif [ "$package" = 'eslint-config-eslint' ]; then
		mv node_modules/eslint-config-eslint/build.js .
		rm node_modules/eslint-config-eslint/*.js
		mv ./build.js node_modules/eslint-config-eslint/
	elif [ "$package" = 'kraken-api' ]; then
		mv node_modules/kraken-api/lint.js .
		rm node_modules/kraken-api/*.js
		mv ./lint.js node_modules/kraken-api/
	# elif [[ "$package" == 'mariadb' ]]; then         # nothing to do ...
	# elif [[ "$package" == 'opencv.js' ]]; then       # nothing to do ...
	fi
fi
