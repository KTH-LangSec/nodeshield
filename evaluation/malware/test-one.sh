#!/bin/sh

package="$1"
version="$2"
strategy="$3"
sbom="$4"
cbom="$5"

if [ -z "$package" ] || [ -z "$version" ] || [ -z "$strategy" ] || [ -z "$sbom" ]; then
	echo 'usage: sh test-one.sh <package> <version> <strategy> <sbom> [cbom]'
	echo '(strategy should be one of "exit", "throw", "log")'
	exit 1
fi

# ---------------------------------------------------------------------------- #

cd "$package-$version" 1>/dev/null 2>/dev/null || true
../.setup.sh "$package" "$version"

# Prepare an under- and over-provisioned based on the default CBOM, in case its
# the one specified
if [ ! -f 'cbom-overprovisioned.json' ]; then
	jq ".["'"'"$package@$version"'"'"]"' = ["crypto", "code", "command", "file-system", "network", "system"]' \
		<cbom.json \
		>cbom-overprovisioned.json
fi
if [ ! -f 'cbom-underprovisioned.json' ]; then
	jq ".["'"'"$package@$version"'"'"]"' = []' \
		<cbom.json \
		>cbom-underprovisioned.json
fi

# Run ...
if [ -z "$cbom" ]; then
	# without an predefined CBOM if none is specified
	node ../.cli/src/cli.js \
		--strategy "$strategy" \
		--sbom "$sbom" \
		-- \
		'index.js'
else
	if [ -n "$INSTALL_TIME_CBOM" ] && expr "$cbom" : '.*cbom\.json$' >/dev/null && [ -f 'cbom-install.json' ]; then
		cbom='./cbom-install.json'
	fi

	# with an predefined CBOM if specified
	node ../.cli/src/cli.js \
		--strategy "$strategy" \
		--sbom "$sbom" \
		--cbom "$cbom" \
		-- \
		'index.js'
fi
