#!/bin/sh

set -e

package="$1"
version="$2"

if [ -z "$package" ] || [ -z "$version" ]; then
	echo 'usage: ./generate-cbom.sh <package> <version>'
	exit 2
fi

./.build.sh

# ---------------------------------------------------------------------------- #

cd "$package-$version"

if [ "$package" = '@roku-web-core-ajax' ]; then
	package='@roku-web-core/ajax'
fi

if [ "$package" = 'conventional-changelog'  ] || [ "$package" = 'event-stream' ] || [ "$package" = 'node-ipc' ] || [ "$package" = 'rate-map' ] || [ "$package" = 'eslint-config-eslint' ] || [ "$package" = 'eslint-scope' ] || [ "$package" = 'kraken-api' ] || [ "$package" = 'mariadb' ] || [ "$package" = 'opencv.js' ]; then
	# For malicious package UPDATES, we want to generate the CBOM for the previous
	# benign version.
	npm clean-install --ignore-scrips
else
	# For purely malicious packages we want to generate the CBOM for the new
	# version
	../.setup.sh "$package" "$version"
fi

sbom='./sbom.json'
if [ -f "sbom-corrected.json" ]; then
	sbom='./sbom-corrected.json'
fi

node ../.cli/src/cli.js \
	--strategy 'exit' \
	--sbom "$sbom" \
	--build-only --cbom-output 'cbom.json' \
	'index.js' 1>/dev/null 2>/dev/null

if [ "$package" = 'conventional-changelog'  ] || [ "$package" = 'event-stream' ] || [ "$package" = 'node-ipc' ] || [ "$package" = 'rate-map' ] || [ "$package" = 'eslint-config-eslint' ] || [ "$package" = 'eslint-scope' ] || [ "$package" = 'kraken-api' ] || [ "$package" = 'mariadb' ] || [ "$package" = 'opencv.js' ]; then
	echo 'not underprovisioning for benign versions'
else
	jq ".["'"'"$package@$version"'"'"]"' = []' \
		<cbom.json \
		>cbom-underprovisioned.json
	rm cbom.json
	if [ "$package" = 'express-cookies' ]; then
		cp cbom-underprovisioned.json cbom.json
	else
		mv cbom-underprovisioned.json cbom.json
	fi
fi

rm -rf node_modules/
