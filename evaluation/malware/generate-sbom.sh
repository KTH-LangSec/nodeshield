#!/bin/sh

set -e

package="$1"
version="$2"

if [ -z "$package" ] || [ -z "$version" ]; then
	echo 'usage: ./generate-sbom.sh <package> <version>'
	exit 2
fi

./.build.sh

if [ "$package-$version" = 'express-cookies-1.4.7' ]; then
	# skip because express-cookies is not in the registry so we can't create a
	# valid SBOM automatically
	exit 0
fi

# ---------------------------------------------------------------------------- #

cd "$package-$version"

sbom='sbom.json'
if [ -f 'sbom-corrected.json' ]; then
	sbom='sbom-corrected.json'
fi

if [ "$package" = '@roku-web-core-ajax' ]; then
	package='@roku-web-core/ajax'
fi

../.setup.sh "$package" "$version"  1>/dev/null 2>/dev/null
npm clean-install --ignore-scrips 1>/dev/null 2>/dev/null
npm sbom --sbom-format cyclonedx >"$sbom"

# Correct the version in the SBOM
installed_version=$(cat package.json | grep "\"$package\"" | sed -E 's/.*"\^?([^"]+)".*/\1/')
sed -i "s/$installed_version/$version/g" "$sbom"

# Update dependsOn list for testcase
dependsOn=$(jq -r '.dependencies[] | select(.ref | test("^demo@")) | .dependsOn[]' "$sbom")
dependsOn=$(printf "%s\n" "$dependsOn" | grep -v "$package@$version" | jq -R . | jq -s .)
jq --arg ref "$package@$version" --argjson dependsOn "$dependsOn" '
  .dependencies = (.dependencies | map(
    if .ref == $ref then
      .dependsOn = (.dependsOn + $dependsOn | unique) | .
    else
      .
    end
  ))
' "$sbom" >"./sbom'.json"
mv "./sbom'.json" "$sbom"

# Update dependsOn list for test project
jq --argjson dependsOn "[\"$package@$version\"]" '
  .dependencies = (.dependencies | map(
    if .ref == "demo@1.0.0" then
      .dependsOn = $dependsOn | .
    else
      .
    end
  ))
' "$sbom" >"./sbom'.json"
mv "./sbom'.json" "$sbom"

# Remove noisy changes
jq 'del(.serialNumber, .metadata.timestamp)' "$sbom" >"./sbom'.json"
mv "./sbom'.json" "$sbom"

# Cleanup
rm -rf node_modules/
